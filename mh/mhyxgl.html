<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Conflux管理员管理页面</title>
  <!-- 使用Conflux官方SDK -->
  <script src="https://cdn.jsdelivr.net/npm/js-conflux-sdk@2.0.7/dist/js-conflux-sdk.umd.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      max-width: 800px;
    }
    .section {
      margin-bottom: 30px;
      padding: 15px;
      border: 1px solid #ddd;
      border-radius: 5px;
    }
    input, select, button {
      padding: 8px;
      margin: 5px 0;
      width: 100%;
      box-sizing: border-box;
    }
    button {
      background-color: #4CAF50;
      color: white;
      border: none;
      cursor: pointer;
    }
    button:hover {
      opacity: 0.9;
    }
    .status {
      margin-top: 10px;
      padding: 10px;
      background-color: #f5f5f5;
      border-radius: 4px;
    }
  </style>
</head>
<body>
  <h1>Conflux链管理员管理</h1>

  <!-- 网络选择 -->
  <div class="section">
    <h3>网络设置</h3>
    <select id="networkSelect">
      <option value="https://main.confluxrpc.com">Conflux主网</option>
      <option value="https://test.confluxrpc.com">Conflux测试网</option>
    </select>
    <button id="connectNetwork">连接网络</button>
    <div id="networkStatus" class="status">未连接网络</div>
  </div>

  <!-- 钱包连接 -->
  <div class="section">
    <h3>钱包连接</h3>
    <button id="connectWallet">连接Conflux钱包</button>
    <div id="walletStatus" class="status">未连接钱包</div>
    <div id="walletInfo" style="display:none;">
      <p>地址: <span id="walletAddress"></span></p>
      <p>余额: <span id="walletBalance"></span> CFX</p>
    </div>
  </div>

  <!-- 合约管理功能 -->
  <div class="section">
    <h3>合约管理</h3>
    <div>
      <label>合约地址: <input type="text" id="contractAddress" value="cfx:type.contract:your-contract-address" /></label>
      <button id="loadContract">加载合约</button>
    </div>
    <div id="contractStatus" class="status">合约未加载</div>
  </div>

  <!-- 管理功能 -->
  <div class="section">
    <h3>盲盒价格设置</h3>
    <input type="number" id="blindBoxPrice" placeholder="输入新价格(单位:GGG)" />
    <button id="updatePriceButton">更新价格</button>
  </div>

  <div class="section">
    <h3>NFT配置更新</h3>
    <select id="nftType">
      <option value="0">普通奶牛</option>
      <option value="1">黄金奶牛</option>
      <option value="2">稀有奶牛</option>
      <option value="3">初级牧场</option>
      <option value="4">中级牧场</option>
      <option value="5">高级牧场</option>
    </select>
    <input type="number" id="productionRate" placeholder="生产率(单位:GDrip)" />
    <input type="number" id="feedRequirement" placeholder="喂养需求(单位:GDrip)" />
    <input type="text" id="imageURI" placeholder="图片URL" />
    <button id="updateNFTConfigButton">更新配置</button>
  </div>

  <div class="section">
    <h3>代币提取</h3>
    <input type="number" id="withdrawAmount" placeholder="数量(单位:个)" />
    <button id="withdrawGGGButton">提取GGG</button>
    <button id="withdrawFGGButton">提取FGG</button>
  </div>

  <script>
    // 全局变量
    let conflux;
    let wallet;
    let contract;
    
    // 合约ABI (与之前相同)
    const contractABI = [
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "gggTokenAddress",
				"type": "address"
			},
			{
				"internalType": "address",
				"name": "fggTokenAddress",
				"type": "address"
			}
		],
		"stateMutability": "nonpayable",
		"type": "constructor"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "sender",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "tokenId",
				"type": "uint256"
			},
			{
				"internalType": "address",
				"name": "owner",
				"type": "address"
			}
		],
		"name": "ERC721IncorrectOwner",
		"type": "error"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "operator",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "tokenId",
				"type": "uint256"
			}
		],
		"name": "ERC721InsufficientApproval",
		"type": "error"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "approver",
				"type": "address"
			}
		],
		"name": "ERC721InvalidApprover",
		"type": "error"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "operator",
				"type": "address"
			}
		],
		"name": "ERC721InvalidOperator",
		"type": "error"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "owner",
				"type": "address"
			}
		],
		"name": "ERC721InvalidOwner",
		"type": "error"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "receiver",
				"type": "address"
			}
		],
		"name": "ERC721InvalidReceiver",
		"type": "error"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "sender",
				"type": "address"
			}
		],
		"name": "ERC721InvalidSender",
		"type": "error"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "tokenId",
				"type": "uint256"
			}
		],
		"name": "ERC721NonexistentToken",
		"type": "error"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "owner",
				"type": "address"
			}
		],
		"name": "OwnableInvalidOwner",
		"type": "error"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "account",
				"type": "address"
			}
		],
		"name": "OwnableUnauthorizedAccount",
		"type": "error"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "owner",
				"type": "address"
			},
			{
				"indexed": true,
				"internalType": "address",
				"name": "approved",
				"type": "address"
			},
			{
				"indexed": true,
				"internalType": "uint256",
				"name": "tokenId",
				"type": "uint256"
			}
		],
		"name": "Approval",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "owner",
				"type": "address"
			},
			{
				"indexed": true,
				"internalType": "address",
				"name": "operator",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "bool",
				"name": "approved",
				"type": "bool"
			}
		],
		"name": "ApprovalForAll",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "owner",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "tokenId",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "enum FarmGame.NFTType",
				"name": "nftType",
				"type": "uint8"
			}
		],
		"name": "BlindBoxOpened",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "buyer",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "tokenId",
				"type": "uint256"
			}
		],
		"name": "BlindBoxPurchased",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"internalType": "enum FarmGame.NFTType",
				"name": "nftType",
				"type": "uint8"
			}
		],
		"name": "ConfigUpdated",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "owner",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "tokenId",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "bool",
				"name": "isGGG",
				"type": "bool"
			}
		],
		"name": "Fed",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "owner",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "tokenId",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "amount",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "bool",
				"name": "isGGG",
				"type": "bool"
			}
		],
		"name": "Harvested",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "previousOwner",
				"type": "address"
			},
			{
				"indexed": true,
				"internalType": "address",
				"name": "newOwner",
				"type": "address"
			}
		],
		"name": "OwnershipTransferred",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "from",
				"type": "address"
			},
			{
				"indexed": true,
				"internalType": "address",
				"name": "to",
				"type": "address"
			},
			{
				"indexed": true,
				"internalType": "uint256",
				"name": "tokenId",
				"type": "uint256"
			}
		],
		"name": "Transfer",
		"type": "event"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "to",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "tokenId",
				"type": "uint256"
			}
		],
		"name": "approve",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "owner",
				"type": "address"
			}
		],
		"name": "balanceOf",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "blindBoxPrice",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"name": "blindBoxRates",
		"outputs": [
			{
				"internalType": "uint8",
				"name": "",
				"type": "uint8"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "tokenId",
				"type": "uint256"
			}
		],
		"name": "calculateHarvestAmount",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "amount",
				"type": "uint256"
			},
			{
				"internalType": "bool",
				"name": "isGGG",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "tokenId",
				"type": "uint256"
			}
		],
		"name": "feed",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "fggToken",
		"outputs": [
			{
				"internalType": "contract FGGToken",
				"name": "",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "tokenId",
				"type": "uint256"
			}
		],
		"name": "getApproved",
		"outputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "gggToken",
		"outputs": [
			{
				"internalType": "contract GGGToken",
				"name": "",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "tokenId",
				"type": "uint256"
			}
		],
		"name": "harvest",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "owner",
				"type": "address"
			},
			{
				"internalType": "address",
				"name": "operator",
				"type": "address"
			}
		],
		"name": "isApprovedForAll",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "name",
		"outputs": [
			{
				"internalType": "string",
				"name": "",
				"type": "string"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "enum FarmGame.NFTType",
				"name": "",
				"type": "uint8"
			}
		],
		"name": "nftConfigs",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "productionRate",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "feedRequirement",
				"type": "uint256"
			},
			{
				"internalType": "string",
				"name": "imageURI",
				"type": "string"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"name": "nftInfos",
		"outputs": [
			{
				"internalType": "enum FarmGame.NFTType",
				"name": "nftType",
				"type": "uint8"
			},
			{
				"internalType": "uint256",
				"name": "lastHarvestTime",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "lastFeedTime",
				"type": "uint256"
			},
			{
				"internalType": "bool",
				"name": "isOpened",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "tokenId",
				"type": "uint256"
			}
		],
		"name": "openBlindBox",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "owner",
		"outputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "tokenId",
				"type": "uint256"
			}
		],
		"name": "ownerOf",
		"outputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "purchaseBlindBox",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "renounceOwnership",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "from",
				"type": "address"
			},
			{
				"internalType": "address",
				"name": "to",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "tokenId",
				"type": "uint256"
			}
		],
		"name": "safeTransferFrom",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "from",
				"type": "address"
			},
			{
				"internalType": "address",
				"name": "to",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "tokenId",
				"type": "uint256"
			},
			{
				"internalType": "bytes",
				"name": "data",
				"type": "bytes"
			}
		],
		"name": "safeTransferFrom",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "operator",
				"type": "address"
			},
			{
				"internalType": "bool",
				"name": "approved",
				"type": "bool"
			}
		],
		"name": "setApprovalForAll",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "newPrice",
				"type": "uint256"
			}
		],
		"name": "setBlindBoxPrice",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "enum FarmGame.NFTType",
				"name": "nftType",
				"type": "uint8"
			},
			{
				"internalType": "uint256",
				"name": "productionRate",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "feedRequirement",
				"type": "uint256"
			},
			{
				"internalType": "string",
				"name": "imageURI",
				"type": "string"
			}
		],
		"name": "setNFTConfig",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "bytes4",
				"name": "interfaceId",
				"type": "bytes4"
			}
		],
		"name": "supportsInterface",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "symbol",
		"outputs": [
			{
				"internalType": "string",
				"name": "",
				"type": "string"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "tokenId",
				"type": "uint256"
			}
		],
		"name": "tokenURI",
		"outputs": [
			{
				"internalType": "string",
				"name": "",
				"type": "string"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "from",
				"type": "address"
			},
			{
				"internalType": "address",
				"name": "to",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "tokenId",
				"type": "uint256"
			}
		],
		"name": "transferFrom",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "newOwner",
				"type": "address"
			}
		],
		"name": "transferOwnership",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "amount",
				"type": "uint256"
			}
		],
		"name": "withdrawFGG",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "amount",
				"type": "uint256"
			}
		],
		"name": "withdrawGGG",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	}
]; // 保持原有ABI不变

    // 初始化Conflux
    function initConflux(networkUrl) {
      try {
        const networkId = networkUrl.includes('test') ? 1 : 1029;
        conflux = new window.Conflux({
          url: networkUrl,
          networkId: networkId,
          logger: console
        });
        return true;
      } catch (error) {
        console.error("初始化失败:", error);
        return false;
      }
    }

    // 连接网络
    document.getElementById('connectNetwork').addEventListener('click', async function() {
      const networkUrl = document.getElementById('networkSelect').value;
      document.getElementById('networkStatus').textContent = "连接中...";
      
      if (initConflux(networkUrl)) {
        try {
          const status = await conflux.getStatus();
          document.getElementById('networkStatus').textContent = 
            `已连接 ${networkUrl} (链ID: ${status.chainId})`;
          document.getElementById('connectWallet').disabled = false;
        } catch (error) {
          document.getElementById('networkStatus').textContent = "连接失败: " + error.message;
        }
      } else {
        document.getElementById('networkStatus').textContent = "初始化失败";
      }
    });

    // 连接钱包
    document.getElementById('connectWallet').addEventListener('click', async function() {
      if (!conflux) {
        alert("请先连接网络");
        return;
      }
      
      document.getElementById('walletStatus').textContent = "连接中...";
      
      try {
        // 检测钱包
        if (typeof window.conflux === 'undefined') {
          throw new Error("请安装Conflux Portal钱包");
        }
        
        // 请求账户访问
        const accounts = await window.conflux.enable();
        wallet = accounts[0];
        
        // 显示钱包信息
        document.getElementById('walletAddress').textContent = wallet;
        document.getElementById('walletInfo').style.display = 'block';
        
        // 获取余额
        const balance = await conflux.getBalance(wallet);
        document.getElementById('walletBalance').textContent = 
          window.Conflux.Drip(balance).toCFX().toDecimalStandardUnit(4);
        
        document.getElementById('walletStatus').textContent = "钱包已连接";
        document.getElementById('loadContract').disabled = false;
        
      } catch (error) {
        document.getElementById('walletStatus').textContent = "连接失败: " + error.message;
        console.error(error);
      }
    });

    // 加载合约
    document.getElementById('loadContract').addEventListener('click', function() {
      const address = document.getElementById('contractAddress').value.trim();
      
      if (!address.startsWith('cfx:type.contract:')) {
        alert("0xc8De5C417a708a5B3ad2508eca4e93004fa2246c");
        return;
      }
      
      try {
        contract = conflux.Contract({
          abi: contractABI,
          address: address
        });
        document.getElementById('contractStatus').textContent = "合约加载成功";
        
        // 启用管理功能
        document.querySelectorAll('#updatePriceButton, #updateNFTConfigButton, #withdrawGGGButton, #withdrawFGGButton')
          .forEach(btn => btn.disabled = false);
          
      } catch (error) {
        document.getElementById('contractStatus').textContent = "合约加载失败: " + error.message;
      }
    });

    // 更新盲盒价格
    document.getElementById('updatePriceButton').addEventListener('click', async function() {
      const price = document.getElementById('blindBoxPrice').value;
      if (!price || price <= 0) {
        alert("请输入有效价格");
        return;
      }
      
      try {
        const priceInDrip = window.Conflux.Drip.fromCFX(price);
        const txHash = await contract.setBlindBoxPrice(priceInDrip).sendTransaction({
          from: wallet
        });
        alert(`价格更新成功!\n交易哈希: ${txHash}`);
      } catch (error) {
        alert("更新失败: " + error.message);
        console.error(error);
      }
    });

    // 更新NFT配置
    document.getElementById('updateNFTConfigButton').addEventListener('click', async function() {
      const nftType = document.getElementById('nftType').value;
      const productionRate = document.getElementById('productionRate').value;
      const feedRequirement = document.getElementById('feedRequirement').value;
      const imageURI = document.getElementById('imageURI').value;
      
      if (!productionRate || !feedRequirement || !imageURI) {
        alert("请填写所有字段");
        return;
      }
      
      try {
        const txHash = await contract.setNFTConfig(
          nftType,
          window.Conflux.Drip.fromCFX(productionRate),
          window.Conflux.Drip.fromCFX(feedRequirement),
          imageURI
        ).sendTransaction({
          from: wallet
        });
        alert(`配置更新成功!\n交易哈希: ${txHash}`);
      } catch (error) {
        alert("更新失败: " + error.message);
        console.error(error);
      }
    });

    // 提取代币
    async function withdrawToken(isGGG) {
      const amount = document.getElementById('withdrawAmount').value;
      if (!amount || amount <= 0) {
        alert("请输入有效数量");
        return;
      }
      
      try {
        const amountInDrip = window.Conflux.Drip.fromCFX(amount);
        const txHash = isGGG 
          ? await contract.withdrawGGG(amountInDrip).sendTransaction({ from: wallet })
          : await contract.withdrawFGG(amountInDrip).sendTransaction({ from: wallet });
          
        alert(`提取成功!\n交易哈希: ${txHash}`);
      } catch (error) {
        alert("提取失败: " + error.message);
        console.error(error);
      }
    }

    document.getElementById('withdrawGGGButton').addEventListener('click', () => withdrawToken(true));
    document.getElementById('withdrawFGGButton').addEventListener('click', () => withdrawToken(false));
  </script>
</body>
</html>
